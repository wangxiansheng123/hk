//图片懒加载替换图片

import $ from 'zepto';

import {isMobile} from 'util';

(function ($) {

    $.extend($, {
        imgLazyLoad: function () {
            var timer,
                len = $('img.lazyload').length;

            function getPos(node) {
                var scrollx = document.documentElement.scrollLeft || document.body.scrollLeft,
                    scrollt = document.documentElement.scrollTop || document.body.scrollTop;
                var pos = node.getBoundingClientRect();
                return {
                    top: pos.top + scrollt,
                    right: pos.right + scrollx,
                    bottom: pos.bottom + scrollt,
                    left: pos.left + scrollx
                }
            }

            function loading() {
                timer && clearTimeout(timer);
                timer = setTimeout(function () {

                    var scrollTop = document.documentElement.scrollTop || document.body.scrollTop,
                        imgs = $('img[data-img]'),
                        screenHeight = document.documentElement.clientHeight;
                    for (var i = 0; i < imgs.length; i++) {
                        var pos = getPos(imgs[i]),
                            posT = pos.top,
                            posB = pos.bottom,
                            screenTop = screenHeight + scrollTop;
                        if ((posT >= scrollTop && posT < screenTop) || (posB > scrollTop && posB < screenTop) || screenTop == 0) {
                            var IMG = imgs[i].getAttribute('data-img');

                            //安卓加webp
                            if (isMobile.Android()) {
                                IMG = IMG + '!/format/webp';
                            }
                            imgs[i].src = IMG;

                            $(imgs[i]).bind('load',function () {
                                $(this).addClass('fadein').removeAttr('data-img');
                                $(this).parent().removeClass('goods-back big-goods-back');
                            })

                        } else {
                            // new Image().src = imgs[i].getAttribute('data-img');
                        }
                    }
                }, 100);
            }

            if (!len) return;
            loading();
            $(window).on('scroll resize', function () {
                if (!$('img[data-img]').length) {
                    return;
                } else {
                    loading();
                }
            })

        }
    })
})($ || Zepto || jQuery);

